<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Crust Uploader</title>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 30px;
    }

    h2 {
      font-size: 26px;
      margin-bottom: 10px;
      color: #333;
    }

    .upload-box {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      margin-bottom: 25px;
    }

    input[type="file"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 100%;
      margin-bottom: 10px;
      font-size: 15px;
    }

    button {
      padding: 10px 18px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background: #0056d2;
    }

    .file-list {
      margin-top: 20px;
    }

    .item {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
    }

    .icon {
      font-size: 40px;
      width: 60px;
      text-align: center;
      margin-right: 15px;
      color: #555;
    }

    .preview-img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      object-fit: cover;
      margin-right: 15px;
      border: 1px solid #ddd;
    }

    .item-details a {
      color: #0066cc;
      text-decoration: none;
    }
    .item-details a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container">

    <h2>Crust File Uploader</h2>

    <div class="upload-box">
      <form id="uploadForm">
        <input 
          type="file" 
          id="fileInput" 
          name="file"
          accept="*/*"
        />
        <button type="submit">Upload File</button>
      </form>
    </div>

    <h3>Uploaded Files</h3>
    <div id="list" class="file-list"></div>

  </div>

  <script>
    const API_BASE = location.origin;

    function fileIcon(mime) {
      if (mime.startsWith("image/")) return "ðŸ–¼ï¸";
      if (mime.startsWith("video/")) return "ðŸŽ¬";
      if (mime.startsWith("audio/")) return "ðŸŽµ";
      if (mime.includes("pdf")) return "ðŸ“„";
      if (mime.includes("zip") || mime.includes("rar")) return "ðŸ—‚ï¸";
      if (mime.includes("word")) return "ðŸ“";
      if (mime.includes("excel")) return "ðŸ“Š";
      if (mime.includes("text")) return "ðŸ“ƒ";
      return "ðŸ“";
    }

    async function loadList() {
      const res = await fetch(API_BASE + "/uploads");
      const items = await res.json();

      const list = document.getElementById("list");
      list.innerHTML = items.map(it => {

        // IMPORTANT: Build URL from CID
        const url = "https://w3s.link/ipfs/" + it.cid;

        const isImg = it.mimeType.startsWith("image/");
        const preview = isImg 
          ? `<img src="${url}" class="preview-img"/>`
          : `<div class="icon">${fileIcon(it.mimeType)}</div>`;

        return `
        <div class="item">
          ${preview}
          <div class="item-details">
            <strong>${it.filename}</strong><br>
            CID: <a href="${url}" target="_blank">${it.cid}</a><br>
            URL: <a href="${url}" target="_blank">${url}</a><br>
            Size: ${(it.size/1024).toFixed(2)} KB<br>
            Uploaded: ${new Date(it.createdAt).toLocaleString()}
          </div>
        </div>
        `;
      }).join("");
    }

    document.getElementById("uploadForm").addEventListener("submit", async e => {
      e.preventDefault();

      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please select a file");

      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch(API_BASE + "/uploads", {
        method: "POST",
        body: fd
      });

      if (!res.ok) {
        const t = await res.text();
        alert("Upload failed: " + t);
        return;
      }

      loadList();
    });

    loadList();
  </script>
</body>
</html>
